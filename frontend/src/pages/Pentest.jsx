import React, { useState, useEffect, useRef } from 'react';

const Pentest = () => {
  const [runs, setRuns] = useState([]);
  const [url, setUrl] = useState('http://testphp.vulnweb.com/');
  const [instruction, setInstruction] = useState('');
  const [isRunning, setIsRunning] = useState(false);
  const [logs, setLogs] = useState([]);
  const [imageUrl, setImageUrl] = useState('');
  const [videoUrl, setVideoUrl] = useState('');
  const ws = useRef(null);

  useEffect(() => {
    const fetchRuns = async () => {
      const response = await fetch('/api/pentest-runs');
      const data = await response.json();
      setRuns(data);
    };

    fetchRuns();

    const backendHost = window.location.host;
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws.current = new WebSocket(`${protocol}//${backendHost}/ws/pentest`);

    ws.current.onopen = () => {
      console.log('WebSocket connection established.');
      setLogs(prevLogs => [...prevLogs, { source: 'client', message: '[CLIENT] WebSocket connection established.' }]);
    };

    ws.current.onmessage = event => {
      console.log('Message received from server:', event.data);
      if (event.data instanceof Blob) {
        console.log('Received Blob, creating object URL.');
        const url = URL.createObjectURL(event.data);
        setImageUrl(url);
      } else {
        if (event.data.startsWith('[VIDEO]')) {
          const backendHost = window.location.host;
          const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
          const videoPath = event.data.split('/')[1];
          setVideoUrl(`${protocol}//${backendHost}/video/${videoPath}`);
        } else if (event.data === '[DONE]') {
          setIsRunning(false);
          setLogs(prevLogs => [...prevLogs, { source: 'client', message: '[CLIENT] Task finished.' }]);
          fetchRuns();
        } else {
          console.log('Received text message.');
          setLogs(prevLogs => [...prevLogs, { source: 'server', message: `[SERVER] ${event.data}` }]);
        }
      }
    };

    ws.current.onclose = () => {
      console.log('Disconnected from WebSocket server');
      setLogs(prevLogs => [...prevLogs, { source: 'client', message: '[ERROR] Disconnected from WebSocket server' }]);
    };

    ws.current.onerror = (error) => {
      console.error('WebSocket error:', error);
      setLogs(prevLogs => [...prevLogs, { source: 'client', message: `[ERROR] WebSocket error: ${error.message}` }]);
    };
  }, []);

  const runPentest = () => {
    if (ws.current && ws.current.readyState === WebSocket.OPEN) {
      setIsRunning(true);
      setLogs(prevLogs => [...prevLogs, { source: 'client', message: '[CLIENT] Sending pentest task...' }]);
      const settings = JSON.parse(localStorage.getItem('settings')) || {};
      const task = { url, instruction, ...settings };
      ws.current.send(JSON.stringify(task));
    } else {
      setLogs(prevLogs => [...prevLogs, { source: 'client', message: '[CLIENT] WebSocket not open.' }]);
    }
  };

  return (
    <div className="flex space-x-8">
      <div className="w-1/3 bg-white shadow-2xl rounded-xl p-8">
        <h2 className="text-4xl font-bold text-gray-800 mb-6">Run Pentest</h2>
        <div className="space-y-6">
          <div>
            <label htmlFor="url-input" className="block text-gray-700 text-sm font-bold mb-2">
              URL
            </label>
            <input
              type="text"
              id="url-input"
              className="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
              value={url}
              onChange={(e) => setUrl(e.target.value)}
              disabled={isRunning}
            />
          </div>
          <div>
            <label htmlFor="instruction-input" className="block text-gray-700 text-sm font-bold mb-2">
              Instruction (Optional)
            </label>
            <textarea
              id="instruction-input"
              className="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 h-48"
              value={instruction}
              onChange={(e) => setInstruction(e.target.value)}
              disabled={isRunning}
              placeholder="e.g., Find all vulnerabilities"
            ></textarea>
          </div>
        </div>
        <div className="mt-8">
          <button
            onClick={runPentest}
            className={`w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 ${isRunning ? 'opacity-50 cursor-not-allowed' : ''}`}
            disabled={isRunning}
          >
            {isRunning ? 'Running...' : 'Run Pentest'}
          </button>
        </div>
      </div>
      <div className="w-2/3 space-y-6">
        <div className="bg-white shadow-lg rounded-lg p-6">
          <h2 className="text-2xl font-semibold text-gray-700 mb-4">Live Browser View</h2>
          <div className="flex justify-center items-center bg-gray-200 rounded-md overflow-hidden">
            {videoUrl ? (
              <video src={videoUrl} controls autoPlay className="max-w-full h-auto border-2 border-gray-300" />
            ) : imageUrl ? (
              <img src={imageUrl} className="max-w-full h-auto border-2 border-gray-300" alt="Real-time browser stream" />
            ) : (
              <p className="text-gray-500 p-4">Waiting for browser stream...</p>
            )}
          </div>
        </div>
        <div className="bg-white shadow-lg rounded-lg p-6">
          <h2 className="text-2xl font-semibold text-gray-700 mb-4">Pentest Logs</h2>
          <div id="logs" className="bg-gray-800 p-4 rounded-md h-64 overflow-y-auto font-mono text-sm">
            {logs.map((log, index) => (
              <p key={index} className={log.source === 'client' ? 'text-blue-400' : 'text-green-400'}>
                {log.message}
              </p>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
};

export default Pentest;
